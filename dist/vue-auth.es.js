var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,a=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,o=(t,r,s)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,u=(e,t)=>{for(var r in t||(t={}))a.call(t,r)&&o(e,r,t[r]);if(s)for(var r of s(t))n.call(t,r)&&o(e,r,t[r]);return e};import{resolveComponent as l,openBlock as i,createBlock as c,createVNode as d,toDisplayString as h,createCommentVNode as m,resolveDynamicComponent as p,withDirectives as f,withCtx as g,createTextVNode as v,vShow as y,Fragment as b,renderList as _}from"vue";import k from"querystring";import{ReactiveRestApi as $}from"@unrest/vue-storage";const A={AUTH_START:"/auth/login/",AUTH_REDIRECT:"/",enabled:!0,signup_enabled:!0,getDisplayName:e=>e.username,modes:[{slug:"login",form_name:"schema/login",title:"Login"},{slug:"sign-up",form_name:"schema/sign-up",title:"Sign Up"},{slug:"reset-password",form_name:"schema/reset-password",title:"Reset Password"}]},T={modal:{outer:e=>`modal ${e}`,content:e=>`modal-content ${e}`}},x={__route:{meta:{authRedirect:!0}},data:()=>({css:T}),computed:{mode(){return A.modes.find((e=>e.slug===this.$route.params.auth_mode))}},methods:{onError(e){var t;null==(t=A.onError)||t.call(A,e)},success(){this.$auth.markStale();const e=this.mode.next||this.$route.query.next||"/";this.$auth.fetch().then((()=>this.$router.replace(e)))}}},P={key:0};x.render=function(e,t,r,s,a,n){const o=l("unrest-schema-form"),u=l("unrest-auth-social-links");return i(),c("div",{class:a.css.modal.outer("-relative unrest-auth")},[d("div",{class:a.css.modal.content("-auto")},[d("h2",null,h(n.mode.title),1),n.mode.text?(i(),c("p",P,h(n.mode.text),1)):m("",!0),d(o,{form_name:n.mode.form_name,success:n.success,onError:n.onError},null,8,["form_name","success","onError"]),d(u),n.mode.extra?(i(),c(p(n.mode.extra),{key:1})):m("",!0)],2)],2)};const R={props:{items:{type:Array,default:()=>[]}},computed:{signup_enabled:()=>A.signup_enabled,display_name(){return A.getDisplayName(this.$auth.user)},enabled:()=>A.enabled,dropdown_items(){const{AUTH_START:e}=A;return[...this.items,{text:"Logout",click:()=>this.$auth.logout().then((()=>this.$router.push(e)))}]}}},S={key:0,class:"unrest-auth-menu"},w={class:"btn -text"},O={key:0,class:"avatar"},U={key:1,class:"fa fa-user"},E={key:1},j=v(" Log In "),H=v(" Sign Up ");R.render=function(e,t,r,s,a,n){const o=l("unrest-dropdown"),u=l("router-link");return n.enabled?f((i(),c("div",S,[e.$auth.user?(i(),c(o,{key:0,items:n.dropdown_items,offset:"16,7",placement:"bottom-end"},{default:g((()=>[d("div",w,[e.$auth.user.avatar_url?(i(),c("div",O,[d("img",{src:e.$auth.user.avatar_url},null,8,["src"])])):(i(),c("i",U)),v(" "+h(n.display_name),1)])])),_:1},8,["items"])):(i(),c("div",E,[d(u,{to:"/auth/login/",class:"btn -link"},{default:g((()=>[j])),_:1}),n.signup_enabled?(i(),c(u,{key:0,to:"/auth/sign-up/",class:"btn -link"},{default:g((()=>[H])),_:1})):m("",!0)]))],512)),[[y,e.$auth.ready]]):m("",!0)};const q={computed:{providers(){var e;return null==(e=A.oauth_providers)?void 0:e.map(this.processProvider)}},methods:{processProvider(e){const t=k.stringify({next:this.$route.next});"string"==typeof e&&(e={slug:e});const{slug:r}=e;return u({title:r[0].toUpperCase()+r.slice(1),href:`/login/${r}/?${t}`,class:`btn btn-${r}`},e)}}},D={key:0,class:"unrest-auth-social"},L=d("div",{className:"unrest-auth-social__or"},"-- Or Connect With --",-1),C={className:"unrest-auth-social__buttons"};q.render=function(e,t,r,s,a,n){var o;return(null==(o=n.providers)?void 0:o.length)?(i(),c("div",D,[L,d("div",C,[(i(!0),c(b,null,_(n.providers,(e=>(i(),c("a",{href:e.href,class:e.class,key:e.slug},h(e.title),11,["href"])))),128))])])):m("",!0)};const I=$({});I.state.ready=!1;const N=()=>A.enabled?I.fetch("auth/user.json").then((({user:e})=>(I.state.ready=!0,e))):Promise.resolve(I.state.user),M=()=>A.enabled?(I.markStale(),N()):Promise.resolve(I.state.user);var F={api:I,get:()=>{var e;return A.enabled?(N(),null==(e=I.get("auth/user.json"))?void 0:e.user):I.state.user},fetch:N,logout:()=>A.enabled?I.fetch("auth/logout/").then(M):Promise.resolve(),refetch:M,markStale:I.markStale};const W=(z=u({AuthForm:x,AuthMenu:R,AuthSocialLinks:q,checkAuth:(e,t,r)=>{e.matched.some((e=>e.meta.authRequired))?F.fetch().then((()=>((e,t)=>{if(F.get())t();else{if(e.path===A.AUTH_START)throw"@unrest/vue-auth detected cyclic redirect";t({path:A.AUTH_START,query:{next:e.fullPath}})}})(e,r))):e.matched.some((e=>e.meta.authRedirect))?F.fetch().then((()=>((e,t)=>{if(F.get()){const r=e.query.next||A.AUTH_REDIRECT;if(e.path===r)throw"@unrest/vue-auth detected cyclic redirect";t(r)}else t()})(e,r))):r()},config:A,configure:e=>{var t;Object.assign(A,e),A.enabled&&"offline"===(null==(t=F.api.state.user)?void 0:t.id)?(F.api.state.user=null,F.api.state.ready=!1):A.enabled||(F.api.state.user={id:"offline"},F.api.state.ready=!0)}},F),t(z,r({get enabled(){return A.enabled},get user(){return F.get()},get ready(){return F.get(),F.api.state.ready},routes:[{path:"/auth/:auth_mode/",name:"auth",component:x,meta:{authRedirect:!0}}],plugin:{install:(e,t)=>{e.config.globalProperties.$auth=W,e.component("UnrestAuthMenu",R),e.component("UnrestAuthSocialLinks",q)}}})));var z;export default W;
