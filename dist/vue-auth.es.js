var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,a=(t,r,s)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,u=(e,t)=>{for(var r in t||(t={}))o.call(t,r)&&a(e,r,t[r]);if(s)for(var r of s(t))n.call(t,r)&&a(e,r,t[r]);return e};import i from"@unrest/css";import{resolveComponent as l,openBlock as c,createBlock as h,createVNode as m,toDisplayString as d,withCtx as p,createTextVNode as g,Fragment as f,renderList as v,createCommentVNode as y}from"vue";import{ReactiveRestApi as b}from"@unrest/vue-reactive-storage";const _={AUTH_START:"/login/",AUTH_REDIRECT:"/",modes:[{slug:"login",form_name:"schema/LoginForm",title:"Login"},{slug:"sign-up",form_name:"schema/SignUpForm",title:"Sign Up"},{slug:"reset-password",form_name:"schema/ResetPassword",title:"Reset Password"}]},k={__route:{meta:{authRedirect:!0}},data:()=>({css:i}),computed:{slug(){return this.$route.path.match(/(login|sign-up|forgot-password)/)[1]},mode(){return _.modes.find((e=>e.slug===this.slug))}},methods:{success(){this.$auth.markStale(),this.$auth.fetch().then((()=>this.$router.replace(this.$route.query.next||"/")))}}};k.render=function(e,t,r,s,o,n){const a=l("schema-form"),u=l("ur-auth-social-links");return c(),h("div",{class:o.css.modal.outer("-relative")},[m("div",{class:o.css.modal.content("-auto")},[m("h2",null,d(n.mode.title),1),m(a,{form_name:n.mode.form_name,success:n.success},null,8,["form_name","success"]),m(u)],2)],2)};const $={props:{items:Array},computed:{user(){return this.$store.auth.get()},dropdown_items(){const{AUTH_START:e}=_;return[...this.items,{text:"Logout",click:()=>this.$auth.logout().then((()=>this.$router.push(e)))}]}}},A={key:1},R=g(" Log In "),S=g(" Sign Up ");$.render=function(e,t,r,s,o,n){const a=l("ur-dropdown"),u=l("router-link");return n.user?(c(),h(a,{key:0,items:n.dropdown_items,title:n.user.username},null,8,["items","title"])):(c(),h("div",A,[m(u,{to:"/auth/login/",class:"btn -link"},{default:p((()=>[R])),_:1}),m(u,{to:"/auth/sign-up/",class:"btn -link"},{default:p((()=>[S])),_:1})]))};var T={};const P={computed:{providers(){var e;return null==(e=_.oauth_providers)?void 0:e.map(this.processProvider)}},methods:{processProvider(e){const t=T.stringify({next:this.$route.next});"string"==typeof e&&(e={slug:e});const{slug:r}=e;return u({title:r[0].toUpperCase()+r.slice(1),href:`/login/${r}/?${t}`,class:`btn btn-${r} mx-4`},e)}}},w={key:0},U=m("div",{className:"my-4 text-center"},"-- Or Connect With --",-1),x={className:"flex justify-center mb-4"};P.render=function(e,t,r,s,o,n){return n.providers?(c(),h("div",w,[U,m("div",x,[(c(!0),h(f,null,v(n.providers,(e=>(c(),h("a",{href:e.href,class:e.class,key:e.slug},d(e.title),11,["href"])))),128))])])):y("",!0)};const O=b();O.state.ready=!1;const j=()=>O.fetch("auth/user.json").then((({user:e})=>(O.state.ready=!0,e))),E=()=>(O.markStale(),j());var L={api:O,get:()=>{var e;return j(),null==(e=O.get("auth/user.json"))?void 0:e.user},fetch:j,logout:()=>O.fetch("auth/logout/").then(E),refetch:E,markStale:O.markStale};var H=(e,t,r)=>{e.matched.some((e=>e.meta.authRequired))?L.fetch().then((()=>((e,t)=>{L.get()?t():t({path:_.AUTH_START,query:{next:e.fullPath}})})(e,r))):e.matched.some((e=>e.meta.authRedirect))?L.fetch().then((()=>((e,t)=>{L.get()?t(e.query.next||_.AUTH_REDIRECT):t()})(e,r))):r()};const q=(C=u({AuthForm:k,AuthMenu:$,AuthSocialLinks:P,config:_},L),t(C,r({get user(){return L.get()},get ready(){return L.get(),L.api.state.ready},routes:[{path:"/auth/:slug/",name:"auth",component:k,meta:{authRedirect:!0}}],plugin:{install:(e,t)=>{e.config.globalProperties.$auth=q,e.component("UrAuthMenu",$),e.component("UrAuthSocialLinks",P);const{$store:r,$router:s}=e.config.globalProperties;r&&(r.auth=q,r.list.push(q)),s&&s.beforeEach(H)}}})));var C;export default q;
