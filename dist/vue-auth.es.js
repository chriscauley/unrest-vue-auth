var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,n=Object.prototype.propertyIsEnumerable,u=(t,r,s)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,a=(e,t)=>{for(var r in t||(t={}))o.call(t,r)&&u(e,r,t[r]);if(s)for(var r of s(t))n.call(t,r)&&u(e,r,t[r]);return e};import i from"@unrest/css";import{resolveComponent as l,openBlock as c,createBlock as m,createVNode as h,toDisplayString as p,withCtx as d,createTextVNode as g,Fragment as f,renderList as v,createCommentVNode as y}from"vue";import b from"querystring";import{ReactiveRestApi as _}from"@unrest/vue-reactive-storage";const k={AUTH_START:"/login/",AUTH_REDIRECT:"/",modes:[{slug:"login",form_name:"schema/LoginForm",title:"Login"},{slug:"sign-up",form_name:"schema/SignUpForm",title:"Sign Up"},{slug:"reset-password",form_name:"schema/ResetPassword",title:"Reset Password"}]},$={__route:{meta:{authRedirect:!0}},data:()=>({css:i}),computed:{slug(){return this.$route.path.match(/(login|sign-up|forgot-password)/)[1]},mode(){return k.modes.find((e=>e.slug===this.slug))}},methods:{success(){this.$auth.markStale(),this.$auth.fetch().then((()=>this.$router.replace(this.$route.query.next||"/")))}}};$.render=function(e,t,r,s,o,n){const u=l("schema-form"),a=l("unrest-auth-social-links");return c(),m("div",{class:o.css.modal.outer("-relative")},[h("div",{class:o.css.modal.content("-auto")},[h("h2",null,p(n.mode.title),1),h(u,{form_name:n.mode.form_name,success:n.success},null,8,["form_name","success"]),h(a)],2)],2)};const A={props:{items:{type:Array,default:()=>[]}},computed:{user(){return this.$store.auth.get()},dropdown_items(){const{AUTH_START:e}=k;return[...this.items,{text:"Logout",click:()=>this.$auth.logout().then((()=>this.$router.push(e)))}]}}},R={key:1},S=g(" Log In "),T=g(" Sign Up ");A.render=function(e,t,r,s,o,n){const u=l("ur-dropdown"),a=l("router-link");return n.user?(c(),m(u,{key:0,items:n.dropdown_items,title:n.user.username},null,8,["items","title"])):(c(),m("div",R,[h(a,{to:"/auth/login/",class:"btn -link"},{default:d((()=>[S])),_:1}),h(a,{to:"/auth/sign-up/",class:"btn -link"},{default:d((()=>[T])),_:1})]))};const P={computed:{providers(){var e;return null==(e=k.oauth_providers)?void 0:e.map(this.processProvider)}},methods:{processProvider(e){const t=b.stringify({next:this.$route.next});"string"==typeof e&&(e={slug:e});const{slug:r}=e;return a({title:r[0].toUpperCase()+r.slice(1),href:`/login/${r}/?${t}`,class:`btn btn-${r} mx-4`},e)}}},w={key:0},U=h("div",{className:"my-4 text-center"},"-- Or Connect With --",-1),x={className:"flex justify-center mb-4"};P.render=function(e,t,r,s,o,n){return n.providers?(c(),m("div",w,[U,h("div",x,[(c(!0),m(f,null,v(n.providers,(e=>(c(),m("a",{href:e.href,class:e.class,key:e.slug},p(e.title),11,["href"])))),128))])])):y("",!0)};const O=_();O.state.ready=!1;const j=()=>O.fetch("auth/user.json").then((({user:e})=>(O.state.ready=!0,e))),E=()=>(O.markStale(),j());var L={api:O,get:()=>{var e;return j(),null==(e=O.get("auth/user.json"))?void 0:e.user},fetch:j,logout:()=>O.fetch("auth/logout/").then(E),refetch:E,markStale:O.markStale};var q=(e,t,r)=>{e.matched.some((e=>e.meta.authRequired))?L.fetch().then((()=>((e,t)=>{L.get()?t():t({path:k.AUTH_START,query:{next:e.fullPath}})})(e,r))):e.matched.some((e=>e.meta.authRedirect))?L.fetch().then((()=>((e,t)=>{L.get()?t(e.query.next||k.AUTH_REDIRECT):t()})(e,r))):r()};const H=(C=a({AuthForm:$,AuthMenu:A,AuthSocialLinks:P,config:k},L),t(C,r({get user(){return L.get()},get ready(){return L.get(),L.api.state.ready},routes:[{path:"/auth/:slug/",name:"auth",component:$,meta:{authRedirect:!0}}],plugin:{install:(e,t)=>{e.config.globalProperties.$auth=H,e.component("UnrestAuthMenu",A),e.component("UnrestAuthSocialLinks",P);const{$store:r,$router:s}=e.config.globalProperties;r&&(r.auth=H,r.list.push(H)),s&&s.beforeEach(q)}}})));var C;export default H;
