var e=Object.defineProperty,t=Object.defineProperties,r=Object.getOwnPropertyDescriptors,s=Object.getOwnPropertySymbols,o=Object.prototype.hasOwnProperty,a=Object.prototype.propertyIsEnumerable,n=(t,r,s)=>r in t?e(t,r,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[r]=s,u=(e,t)=>{for(var r in t||(t={}))o.call(t,r)&&n(e,r,t[r]);if(s)for(var r of s(t))a.call(t,r)&&n(e,r,t[r]);return e};import{resolveComponent as i,openBlock as l,createBlock as c,createVNode as d,toDisplayString as m,withDirectives as h,withCtx as p,vShow as g,createCommentVNode as f,createTextVNode as v,Fragment as b,renderList as y}from"vue";import $ from"querystring";import{ReactiveRestApi as _}from"@unrest/vue-reactive-storage";const k={AUTH_START:"/login/",AUTH_REDIRECT:"/",enabled:!0,modes:[{slug:"login",form_name:"schema/LoginForm",title:"Login"},{slug:"sign-up",form_name:"schema/SignUpForm",title:"Sign Up"},{slug:"reset-password",form_name:"schema/ResetPassword",title:"Reset Password"}]},P={modal:{outer:e=>`modal ${e}`,content:e=>`modal-content ${e}`}},A={__route:{meta:{authRedirect:!0}},data:()=>({css:P}),computed:{slug(){return this.$route.path.match(/(login|sign-up|forgot-password)/)[1]},mode(){return k.modes.find((e=>e.slug===this.slug))}},methods:{success(){this.$auth.markStale(),this.$auth.fetch().then((()=>this.$router.replace(this.$route.query.next||"/")))}}};A.render=function(e,t,r,s,o,a){const n=i("unrest-schema-form"),u=i("unrest-auth-social-links");return l(),c("div",{class:o.css.modal.outer("-relative")},[d("div",{class:o.css.modal.content("-auto")},[d("h2",null,m(a.mode.title),1),d(n,{form_name:a.mode.form_name,success:a.success},null,8,["form_name","success"]),d(u)],2)],2)};const R={props:{items:{type:Array,default:()=>[]}},computed:{enabled:()=>k.enabled,dropdown_items(){const{AUTH_START:e}=k;return[...this.items,{text:"Logout",click:()=>this.$auth.logout().then((()=>this.$router.push(e)))}]}}},S={key:0,class:"unrest-auth-menu"},T={key:1},w=v(" Log In "),O=v(" Sign Up ");R.render=function(e,t,r,s,o,a){const n=i("unrest-dropdown"),u=i("router-link");return a.enabled?h((l(),c("div",S,[e.$auth.user?(l(),c(n,{key:0,items:a.dropdown_items,title:e.$auth.user.username},null,8,["items","title"])):(l(),c("div",T,[d(u,{to:"/auth/login/",class:"btn -link"},{default:p((()=>[w])),_:1}),d(u,{to:"/auth/sign-up/",class:"btn -link"},{default:p((()=>[O])),_:1})]))],512)),[[g,e.$auth.ready]]):f("",!0)};const U={computed:{providers(){var e;return null==(e=k.oauth_providers)?void 0:e.map(this.processProvider)}},methods:{processProvider(e){const t=$.stringify({next:this.$route.next});"string"==typeof e&&(e={slug:e});const{slug:r}=e;return u({title:r[0].toUpperCase()+r.slice(1),href:`/login/${r}/?${t}`,class:`btn btn-${r} mx-4`},e)}}},j={key:0},x=d("div",{className:"my-4 text-center"},"-- Or Connect With --",-1),E={className:"flex justify-center mb-4"};U.render=function(e,t,r,s,o,a){return a.providers?(l(),c("div",j,[x,d("div",E,[(l(!0),c(b,null,y(a.providers,(e=>(l(),c("a",{href:e.href,class:e.class,key:e.slug},m(e.title),11,["href"])))),128))])])):f("",!0)};const L=_({});L.state.ready=!1;const q=()=>k.enabled?L.fetch("auth/user.json").then((({user:e})=>(L.state.ready=!0,e))):Promise.resolve(L.state.user),H=()=>k.enabled?(L.markStale(),q()):Promise.resolve(L.state.user);var C={api:L,get:()=>{var e;return k.enabled?(q(),null==(e=L.get("auth/user.json"))?void 0:e.user):L.state.user},fetch:q,logout:()=>k.enabled?L.fetch("auth/logout/").then(H):Promise.resolve(),refetch:H,markStale:L.markStale};var I=(e,t,r)=>{e.matched.some((e=>e.meta.authRequired))?C.fetch().then((()=>((e,t)=>{C.get()?t():t({path:k.AUTH_START,query:{next:e.fullPath}})})(e,r))):e.matched.some((e=>e.meta.authRedirect))?C.fetch().then((()=>((e,t)=>{C.get()?t(e.query.next||k.AUTH_REDIRECT):t()})(e,r))):r()};const D=(F=u({AuthForm:A,AuthMenu:R,AuthSocialLinks:U,config:k,configure:e=>{var t;Object.assign(k,e),k.enabled&&"offline"===(null==(t=C.api.state.user)?void 0:t.id)?(C.api.state.user=null,C.api.state.ready=!1):k.enabled||(C.api.state.user={id:"offline"},C.api.state.ready=!0)}},C),t(F,r({get enabled(){return k.enabled},get user(){return C.get()},get ready(){return C.get(),C.api.state.ready},routes:[{path:"/auth/:slug/",name:"auth",component:A,meta:{authRedirect:!0}}],plugin:{install:(e,t)=>{e.config.globalProperties.$auth=D,e.component("UnrestAuthMenu",R),e.component("UnrestAuthSocialLinks",U);const{$store:r,$router:s}=e.config.globalProperties;r&&(r.auth=D,r.list.push(D)),s&&s.beforeEach(I)}}})));var F;export default D;
